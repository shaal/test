<?php

/**
 * @file
 * Contains custom Tower Health code.
 *
 * @copyright Copyright (c) 2019 Palantir.net
 */

use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;
use Drupal\views\Views;
use Drupal\Core\Form\FormStateInterface;

/**
 * Add custom sort order for find a provider search.
 *
 * @param object\ViewExecutable $view
 *   View to alter.
 * @param object\QueryPluginBase $query
 *   View query.
 */
function towerhealth_misc_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() == 'find_a_provider') {
    // Sort by provider type custom solr field first.
    $query->sort('provider_sort_field', 'ASC');
    // Then sort by relevance.
    $query->sort('search_api_relevance', 'DESC');
    // And finally by name.
    $query->sort('title', 'ASC');
  }
}

/**
 * @param $form
 * @param $form_state
 * @param $form_id
 */
function towerhealth_misc_form_alter(&$form, &$form_state, $form_id) {

  if ($form['#id'] == 'views-exposed-form-find-a-location-find-location') {
    /** @var \Drupal\views\Plugin\views\exposed_form\ExposedFormPluginBase $exposed_form_plugin */
    //$form = $view->display_handler->viewExposedFormBlocks();
    $view_id = 'find_a_location';
    $view_display_id = 'find_location';

    /** @var \Drupal\views\ViewExecutable $view */
    $view = Views::getView($view_id);
    $view->setDisplay($view_display_id);

    $query_plugin = $view->getQuery();

    // Retrieve the facet source.
    $query = $query_plugin->getSearchApiQuery();
    $display_id = $query->getSearchId(FALSE);
    $facet_source_id = str_replace(':', '__', 'search_api:' . $display_id);
    $facet_source = \Drupal::entityTypeManager()
      ->getStorage('facets_facet_source')
      ->load($facet_source_id);

    if ($facet_source) {
      // Get the active facet filters from the query parameters.
      $filter_key = $facet_source->getFilterKey() ?: 'f';
      $filters = \Drupal::request()->query->get($filter_key, []);
      // Iterate through the facet filters.
      foreach ($filters as $key => $value) {
        if (!is_string($value)) {
          continue;
        }
        // Add a hidden form field for the facet parameter.
        $form['facets']["{$filter_key}[$key]"] = [
          '#type' => 'hidden',
          '#value' => $value,
        ];
      }
    }
  }
}